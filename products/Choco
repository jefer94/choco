FROM node:14-alpine3.10

ENV APP_ENV=production
ENV SESSION_SECRET=""
ENV SESSION_EXPIRATION=604800
ENV PORT=3000
ENV SALT_ROUNDS=4
ENV MONGO_URI=mongodb://mongo:27017/interpreter-hub
ENV BUCKET=""
ENV IAM_KEY=""
ENV IAM_SECRET=""


EXPOSE 3000
EXPOSE 2000

WORKDIR /usr/src/app
RUN mkdir -p /usr/src/app

COPY package.json package.json
COPY packages/configs/package.json packages/configs/package.json
COPY packages/env/package.json packages/env/package.json
COPY packages/middlewares/package.json packages/middlewares/package.json
COPY packages/functional/package.json packages/functional/package.json
# api

COPY packages/components/package.json packages/components/package.json
COPY packages/keychain/package.json packages/keychain/package.json
# app

RUN yarn

# COPY packages/cache packages/cache
COPY packages/configs packages/configs
COPY packages/env packages/env
COPY packages/middlewares packages/middlewares
COPY packages/functional packages/functional
# api

COPY packages/components packages/components
COPY packages/keychain packages/keychain
# app

COPY scripts scripts

RUN chmod +x ./scripts/*/*
RUN yarn build
# RUN yarn --prod=true
# RUN yarn cache clean

ENTRYPOINT ["sh", "./scripts/docker/entrypoint.sh"]
